<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Map Watch - Map Statistics by Grahf_Azura</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<link rel="icon" href="../images/icon.ico">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css" integrity="sha384-aUGj/X2zp5rLCbBxumKTCw2Z50WgIr1vs/PFN4praOTvYXWlVyh2UtNUU0KAUhAX" crossorigin="anonymous">

<link rel="stylesheet" href='https://cdn.datatables.net/1.10.10/css/jquery.dataTables.min.css'>
<!-- <link rel="stylesheet" href='https://code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css'>
<link rel="stylesheet" href='https://cdn.datatables.net/1.10.10/css/dataTables.jqueryui.min.css'> -->

<script src='https://code.jquery.com/jquery-1.11.3.min.js'></script>
<script src='https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js'></script>
<script src='https://cdn.datatables.net/1.10.10/js/dataTables.bootstrap.min.js'></script>

<script src='../js/sql.js'></script>
<script src='../js/map_names.js'></script>
<script src='../js/settings.js'></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>

<script>
/*

TODO: Get this to work in all browsers (Tested: Latest Chrome, FF, and IE10) 

*/

google.load('visualization', '1.1', {packages: ['corechart']});
google.setOnLoadCallback(chartsReady);

function chartsReady() {
	document.getElementById("db_load_btn").disabled = false;
	$('#db_load_link').bind("click", function () {
        $('#db_load_btn').click();
    });
}
function dbReady() {
	$('#tab_links').addClass("tab-links-show");
}

window.onload = function () { 
	//Check the support for the File API support 
	if (window.File && window.FileReader && window.FileList && window.Blob) {
		var fileSelected = document.getElementById('db_load_btn');
		fileSelected.addEventListener('change', function (e) {
			//Get the file object 
			var fileTobeRead = fileSelected.files[0];
			var r = new FileReader();
			r.onload = function() {
				var Uints = new Uint8Array(r.result);
				db = new SQL.Database(Uints);
				getData(db);
				dbReady();
			}
			r.readAsArrayBuffer(fileTobeRead);
		}, false);
	} else { 
		alert("File loading is not supported in this old browser you got here, sorry."); 
	}
	$("#tab6").addClass("tabs");
	activate_tab(1);
	$('#tab_link1').click(function(){ activate_tab(1); return false; });
	$('#tab_link2').click(function(){ activate_tab(2); return false; });
	$('#tab_link3').click(function(){ activate_tab(3); return false; });
    $('#tab_link4').click(function(){ activate_tab(4); return false; });
    $('#tab_link5').click(function(){ activate_tab(5); return false; });
	$('#tab_link6').click(function(){ activate_tab(6); return false; });
}

function activate_tab(num) {
    $('#tab1').removeClass('tab-active');
    $('#tab_link1').removeClass("tab-link-active");
    $('#tab2').removeClass('tab-active');
    $('#tab_link2').removeClass("tab-link-active");
    $('#tab3').removeClass('tab-active');
    $('#tab_link3').removeClass("tab-link-active");
    $('#tab4').removeClass('tab-active');
    $('#tab_link4').removeClass("tab-link-active");
    $('#tab5').removeClass('tab-active');
    $('#tab_link5').removeClass("tab-link-active");
    $('#tab6').removeClass('tab-active');
    $('#tab_link6').removeClass("tab-link-active");
    switch(num) {
        case 1:
        $('#tab1').addClass('tab-active');
        $('#tab_link1').addClass('tab-link-active');
        break;
        case 2:
        $('#tab2').addClass('tab-active');
        $('#tab_link2').addClass('tab-link-active');
        break;
        case 3:
        $('#tab3').addClass('tab-active');
        $('#tab_link3').addClass('tab-link-active');
        break;
        case 4:
        $('#tab4').addClass('tab-active');
        $('#tab_link4').addClass('tab-link-active');
        break;
        case 5:
        $('#tab5').addClass('tab-active');
        $('#tab_link5').addClass('tab-link-active');
        break;
        case 6:
        $('#tab6').addClass('tab-active');
        $('#tab_link6').addClass('tab-link-active');
        break;
    }
}

function getData(db) {
	$("#tab1").removeClass("tabs");
	$("#tab2").removeClass("tabs");
	$("#tab3").removeClass("tabs");
    $("#tab4").removeClass("tabs");
    $("#tab5").removeClass("tabs");
	$("#tab6").removeClass("tabs");

    // Search 'Gen Stat'
	all_gen_stats = [
		['Amount of Map Drops', 0],
		['Map Drops Per Hour', 0],
		['Amount of Time Spent in Maps', 0],
		['Average Time Spent in each Map', 0],
		['Favorite Map to Run', ''],
		['Most Dropped Map', ''],
		['Most Dropped Map Tier', 0],
		['Most Ran Map Tier', 0],
		['Highest Map Tier Ran', 0],
		['Highest Map IQ Ran', 0],
		['Highest Map IR Ran', 0],
		['Highest Map Pack Size Ran', 0]
	];
	var all_gen_stat_names = all_gen_stats.map(function (element) {return element[0];});

	/**********
	* Get number of +0 +1 +2 Map Tier drops in maps ran.  Average Map Returns!
	******/
	var maps_dropped = db.prepare("SELECT Dropped_In_ID, Tier FROM Maps_Dropped WHERE Dropped_In_ID > 0");
	var maps_ran = db.prepare("SELECT Time_Stamp_ID, Tier FROM Maps_Ran");
	var map_returns = [['Map Tier', '-2 or Lower Returns', '-1 Returns', 'Even Returns', '+1 Returns', '+2 Returns', 'Overall Gain']];
	var i = 0;
	var t = 0;
	var same_tier = false;
	var tier_count = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; // used for averaging (20 tiers? cuz reasons, what's with the questions? are you a cop? you know you have to tell me if you're a cop.)
	while (maps_ran.step()) {
		var map_ran = maps_ran.getAsObject()['Time_Stamp_ID'];
		var map_tier = String(maps_ran.getAsObject()['Tier']);
		var overall_gain = -1;
		var a = 0;
		//var tier_index = map_returns.map((el) => el[0]).indexOf(map_tier); // Note: doesn't work in IE10 and below
		var tier_index = map_returns.map(function (element) {return element[0];}).indexOf(map_tier);
		tier_count[+map_tier - 1] += 1;
		// If tier already added, save index (t) then update an already added tier
		if (tier_index > -1) {
			if (!same_tier) t = i;
			i = tier_index;
			same_tier = true;
		} else if (i <= t) {
			same_tier = false;
			i = t;
			i += 1;
			map_returns[i] = [map_tier,0,0,0,0,0,0];
		} else {
			same_tier = false;
			i += 1;
			map_returns[i] = [map_tier,0,0,0,0,0,0];
		}
		while (maps_dropped.step()) {
			if (map_ran == maps_dropped.getAsObject()['Dropped_In_ID']) {
				var tier_drop = maps_dropped.getAsObject()['Tier'];
				var map_return = tier_drop - map_tier;
				switch (map_return) {
					case 7:
					case 6:
					case 5:
					case 4:
					case 3:// Note: just for testing faked data, these ^numbers are not posible drops in game
					case 2:
					map_returns[i][5] += 1;
					overall_gain += 3;
					break;
					case 1:
					map_returns[i][4] += 1;
					overall_gain += 2;
					break;
					case 0:
					map_returns[i][3] += 1;
					overall_gain += 1;
					break;
					case -1:
					map_returns[i][2] += 1;
					overall_gain += 1/3;
					break;
					default:
					map_returns[i][1] += 1;
					overall_gain += 1/9; // TODO: this is not really accurate since its -2 or lower
					break;
				}
			}
		}
		map_returns[i][6] += Math.round(overall_gain * 10) / 10;
	}
	// Sorted Ascending (thought the first index which are words would throw this off but it works fine)
	map_returns.sort(function(a, b) {
		var keyA = +a[0];
		var keyB = +b[0];
		if(keyA < keyB) return -1;
		if(keyA > keyB) return 1;
		return 0;
	});
	// Average the numbers where there are multiple same tiers ran
	for (var i = 0; i < tier_count.length; i++) {
		if (tier_count[i] > 1) {
			//var tier_index = map_returns.map((el) => el[0]).indexOf(String(i+1)); // Note: doesn't work in IE10 and below
			var tier_index = map_returns.map(function (element) {return element[0];}).indexOf(String(i+1));
			for (var n = 1; n < map_returns[tier_index].length; n++) {
				if (map_returns[tier_index][n] > 0)
					map_returns[tier_index][n] /= tier_count[i];
			}
			// Add the number of maps ran in this tier (will no longer be able to map and find index of tiers in muli-array beyond this point)
			map_returns[tier_index][0] += ' ('+tier_count[i]+')';
		}
	}
	console.log(map_returns);
	avgMapReturns(map_returns);

	/**********
	* Get number of Maps dropped by Tier.  Count All Map Drops!
	******/
	var maps_dropped = db.prepare("SELECT Tier FROM Maps_Dropped");
	all_drops = [
		['1',0],['2',0],['3',0],['4',0],['5',0],['6',0],['7',0],['8',0],
		['9',0],['10',0],['11',0],['12',0],['13',0],['14',0],['15',0]
	];
	/*all_drops = [ // tooltip bugged
		['1',0,allMapDropsTooltip(1,0)],['2',0,allMapDropsTooltip(1,0)],['3',0,allMapDropsTooltip(1,0)],
		['4',0,allMapDropsTooltip(1,6)],['5',0,allMapDropsTooltip(1,0)],['6',0,allMapDropsTooltip(1,0)],
		['7',0,allMapDropsTooltip(1,0)],['8',0,allMapDropsTooltip(1,0)],['9',0,allMapDropsTooltip(1,0)],
		['10',0,allMapDropsTooltip(1,0)],['11',0,allMapDropsTooltip(1,0)],['12',0,allMapDropsTooltip(1,0)],
		['13',0,allMapDropsTooltip(1,0)],['14',0,allMapDropsTooltip(1,0)],['15',0,allMapDropsTooltip(1,0)]
	];*/
	var i = 0;
	while (maps_dropped.step()) {
		var tier_drop = maps_dropped.getAsObject()['Tier'];
		// Note: (tier_index=String(tier_drop-1)) will be surfice but I might want to change the number to a string with extra words
		//var tier_index = all_drops.map((el) => el[0]).indexOf(String(tier_drop)); // Note: doesn't work in IE10 and below
		var tier_index = all_drops.map(function (element) {return element[0];}).indexOf(String(tier_drop));
		if (tier_index > -1) {
			all_drops[tier_index][1] += 1;
		}
	}
	allMapDrops(all_drops);

	/**********
	* Get all map data to be placed into a table.  Raw Map Data!
	******/
	var maps_dropped = db.prepare("SELECT * FROM Maps_Dropped WHERE Dropped_In_ID > 0");
	var maps_dropped_unlinked = db.prepare("SELECT * FROM Maps_Dropped WHERE Dropped_In_ID IS NULL OR Dropped_In_ID = ''");
	var maps_ran = db.prepare("SELECT * FROM Maps_Ran");
	all_maps_ran = [];
	all_maps_dropped = [];
	var i = 0;
	while (maps_ran.step()) {
		all_maps_ran.push([i]);
		all_maps_dropped.push([]); // Adding new array that will later be filled with map drops for that map ran.
		//console.log("my object: %o", maps_ran.getAsObject())
		var map = maps_ran.getAsObject();
		Object.keys(map).forEach(function(key) {
			var val = (map[key]) ? map[key] : '';
			// Compressing Map Mods into 2 columns
			if (key == 'Mod1') {
				all_maps_ran[i].push(val);
			}
			else if (['Mod2','Mod3','Mod4'].indexOf(key) > -1) {
				if (val)
					all_maps_ran[i][9] += '<br>'+val;
			}
			else if (key == 'Mod5') {
				all_maps_ran[i].push(val);
			}
			else if (['Mod6','Mod7','Mod8','Mod9'].indexOf(key) > -1) {
				if (val)
					all_maps_ran[i][10] += '<br>'+val;
			}
			else {
				all_maps_ran[i].push(val);
			}
		});
		i++;
	}
	all_maps_ran.push([i,"Unlinked Map Drops","","","","","","","","","",""]);
	console.log(all_maps_ran);
	console.log('^^^');
	var n = 0;
	var m = 0;
	while (maps_dropped.step()) {
		var map = maps_dropped.getAsObject();
		// This loops until it finds the corect map ran for this map drop, because some maps ran might not have any map drops at all
		while (map['Dropped_In_ID'] != all_maps_ran[n][1]) {
			n++;
			m = 0;
		}
		all_maps_dropped[n].push([]);
		Object.keys(map).forEach(function(key) {
			var val = (map[key]) ? map[key] : '';
			// Compressing Map Mods into 2 columns
			if (key == 'Mod1') {
				all_maps_dropped[n][m].push(val);
			}
			else if (['Mod2','Mod3','Mod4'].indexOf(key) > -1) {
				if (val)
					all_maps_dropped[n][m][7] += '<br>'+val;
			}
			else if (key == 'Mod5') {
				all_maps_dropped[n][m].push(val);
			}
			else if (['Mod6','Mod7','Mod8','Mod9'].indexOf(key) > -1) {
				if (val)
					all_maps_dropped[n][m][8] += '<br>'+val;
			}
			else {
				all_maps_dropped[n][m].push(val);
			}
		});
		m++;
	}
	n = all_maps_ran.length - 1; // Last map index is a place holder for Unlinked Map Drops, start there.
	m = 0;
	all_maps_dropped.push([])
	while (maps_dropped_unlinked.step()) {
		var map = maps_dropped_unlinked.getAsObject();
		all_maps_dropped[n].push([]);
		Object.keys(map).forEach(function(key) {
			var val = (map[key]) ? map[key] : '';
			// Compressing Map Mods into 2 columns
			if (key == 'Mod1') {
				all_maps_dropped[n][m].push(val);
			}
			else if (['Mod2','Mod3','Mod4'].indexOf(key) > -1) {
				if (val)
					all_maps_dropped[n][m][7] += '<br>'+val;
			}
			else if (key == 'Mod5') {
				all_maps_dropped[n][m].push(val);
			}
			else if (['Mod6','Mod7','Mod8','Mod9'].indexOf(key) > -1) {
				if (val)
					all_maps_dropped[n][m][8] += '<br>'+val;
			}
			else {
				all_maps_dropped[n][m].push(val);
			}
		});
		m++;
	}
	console.log(all_maps_dropped);
	allMapDataTable(all_maps_ran, all_maps_dropped);

	/**********
	* Get number of map drops sorted by IQ of map ran.  Map Drops by IQ Range!
	******/
	var map_drops_by_iq = [
		['IQ Range', 'Maps Dropped'],
		['IQ Range: 0-29%',		0],
		['IQ Range: 30-59%',	0],
		['IQ Range: 60%-89%',	0],
		['IQ Range: 90%-119%',	0],
		['IQ Range: 120%+',		0]
	];
	var maps_ran_by_iq = [0,0,0,0,0];
	var maps_dropped = db.prepare("SELECT Dropped_In_ID FROM Maps_Dropped WHERE Dropped_In_ID > 0");
	var maps_ran = db.prepare("SELECT Time_Stamp_ID, IQ, Bonus_IQ FROM Maps_Ran");
	while (maps_dropped.step()) {
		var md_id = maps_dropped.getAsObject()['Dropped_In_ID'];
		var iq = 0;
		while (maps_ran.step()) {
			if (md_id == maps_ran.getAsObject()['Time_Stamp_ID']) {
				iq = +maps_ran.getAsObject()['IQ'] + maps_ran.getAsObject()['Bonus_IQ'];
				if(iq < 30) {
					map_drops_by_iq[1][1]++;
				}
				else if (iq >= 30 && iq < 60) {
					map_drops_by_iq[2][1]++;
				}
				else if (iq >= 60 && iq < 90) {
					map_drops_by_iq[3][1]++;
				}
				else if (iq >= 90 && iq < 120) {
					map_drops_by_iq[4][1]++;
				}
				else if (iq >= 120) {
					map_drops_by_iq[5][1]++;
				}
			}
		}
	}
	mapDropsByIQ(map_drops_by_iq, 1);
	while (maps_ran.step()) {
		iq = +maps_ran.getAsObject()['IQ'] + maps_ran.getAsObject()['Bonus_IQ'];
		if (iq < 30) {
			if (++maps_ran_by_iq[0] > 1)
				map_drops_by_iq[1][0] = 'IQ Range: 0-29% \n-Averaged over '+maps_ran_by_iq[0]+' maps';
		}
		else if (iq >= 30 && iq < 60) {
			if (++maps_ran_by_iq[1] > 1)
				map_drops_by_iq[2][0] = 'IQ Range: 30-59% \n-Averaged over '+maps_ran_by_iq[1]+' maps';
		}
		else if (iq >= 60 && iq < 90) {
			if (++maps_ran_by_iq[2] > 1)
				map_drops_by_iq[3][0] = 'IQ Range: 60%-89% \n-Averaged over '+maps_ran_by_iq[2]+' maps';
		}
		else if (iq >= 90 && iq < 120) {
			if (++maps_ran_by_iq[3] > 1)
				map_drops_by_iq[4][0] = 'IQ Range: 90%-119% \n-Averaged over '+maps_ran_by_iq[3]+' maps';
		}
		else if (iq >= 120) {
			if (++maps_ran_by_iq[4] > 1)
				map_drops_by_iq[5][0] = 'IQ Range: 120%+ \n-Averaged over '+maps_ran_by_iq[4]+' maps';
		}
	}
	for (var i = 0; i < 5; i++) {
		map_drops_by_iq[i+1][1] = Math.round(map_drops_by_iq[i+1][1] / maps_ran_by_iq[i] * 10) / 10;
	}
	console.log(map_drops_by_iq);
	mapDropsByIQ(map_drops_by_iq, 2);
	
	// Gen Stat
	var i_avgtm = all_gen_stat_names.indexOf('Average Time Spent in each Map');
	var i_amotm = all_gen_stat_names.indexOf('Amount of Time Spent in Maps');

    /**********
    * Get time between maps ran and average the time within tiers. Average Clear Speeds!
    ******/
    var avg_clear_speeds = [["Map Tier", "Average Clear Time", { role: "style" } ]];
    var clear_speeds = [['Clear Speed', 'Map Tier Count'],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0]];
    var maps_ran = db.prepare("SELECT Time_Stamp_ID, Tier, Time_Cleared FROM Maps_Ran WHERE Time_Cleared > 0");
    while (maps_ran.step()) {
        var tier = maps_ran.getAsObject()['Tier'];
        var start = maps_ran.getAsObject()['Time_Stamp_ID'];
        var end = maps_ran.getAsObject()['Time_Cleared'];
        clear_speeds[tier][0] += end - start;
        clear_speeds[tier][1] += 1;
        // Gen Stat
        all_gen_stats[i_avgtm][1] += 1;
        all_gen_stats[i_amotm][1] += end - start;
    }
    for (var i = 1; i < clear_speeds.length; i++) {
        if (clear_speeds[i][1] > 0) {
            time = formatChartTime(clear_speeds[i][0] / clear_speeds[i][1]);
            var count = '';
            if (clear_speeds[i][1] > 1) {
                var count = ' ('+String(clear_speeds[i][1])+')';
            }
            var color = 'grey'
            if (i > 6) {
                color = 'gold'
            }
            if (i > 11) {
                color = 'red'
            }
            avg_clear_speeds.push([String(i)+count, time, color]);
        }
    }
    console.log(avg_clear_speeds);
    avgClearTimes(avg_clear_speeds);

    // Gen Stat
    all_gen_stats[i_avgtm][1] = formatTime(all_gen_stats[i_amotm][1] / all_gen_stats[i_avgtm][1], true);

	/**********
    * General Map Statistics.  Some may be found in other (above) loops.  Search 'Gen Stat'
    ******/
    // TODO: what about ties?
	var maps_dropped = db.prepare("SELECT * FROM Maps_Dropped");
	var maps_ran = db.prepare("SELECT * FROM Maps_Ran");
	var i_amd = all_gen_stat_names.indexOf('Amount of Map Drops');
	var i_mdh = all_gen_stat_names.indexOf('Map Drops Per Hour');
	var i_mdm = all_gen_stat_names.indexOf('Most Dropped Map');
	var i_mdt = all_gen_stat_names.indexOf('Most Dropped Map Tier');
	var i_fmr = all_gen_stat_names.indexOf('Favorite Map to Run');
	var i_mrt = all_gen_stat_names.indexOf('Most Ran Map Tier');
	var i_hmtier = all_gen_stat_names.indexOf('Highest Map Tier Ran');
	var i_hmiq = all_gen_stat_names.indexOf('Highest Map IQ Ran');
	var i_hmir = all_gen_stat_names.indexOf('Highest Map IR Ran');
	var i_hmps = all_gen_stat_names.indexOf('Highest Map Pack Size Ran');
	var most_dropped = [];
	var base_map_name = '';
	var most_dropped_tier = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
	var all_maps_linked = 0;
	while (maps_dropped.step()) {
		var name = maps_dropped.getAsObject()['Name'];
		var tier = maps_dropped.getAsObject()['Tier'];
		var drop_ID = maps_dropped.getAsObject()['Dropped_In_ID'];
		for (var i in base_map_names) {
			if (name.indexOf(base_map_names[i]) > -1) {
				base_map_name = base_map_names[i];
				break;
			}
		}
		var name_i = most_dropped.map(function (element) { return element[0]; }).indexOf(base_map_name);
		if (name_i > -1) {
			most_dropped[name_i][1] += 1;
		}
		else {
			most_dropped.push([base_map_name, 1]);
		}
		most_dropped_tier[tier-1] += 1;
		if (drop_ID > 0) {
			all_maps_linked += 1;
		}
	}

	var all_maps_unlinked = most_dropped_tier.reduce(function(a, b) { return a + b; });
	all_gen_stats[i_amd][1] = all_maps_unlinked + ' (' + all_maps_linked + ' linked)';

	all_gen_stats[i_mdh][1] = Math.round( all_maps_linked / timeToHoursDecimal(all_gen_stats[i_amotm][1]) * 1000) / 1000;
	
	var most_dropped_map = most_dropped.reduce(function(max, arr) { return max[1] >= arr[1] ? max : arr; });
	all_gen_stats[i_mdm][1] = most_dropped_map[0] + ' (with ' + most_dropped_map[1] + ' drops)';
	
	var itier = most_dropped_tier.indexOf(Math.max.apply(Math, most_dropped_tier));
	all_gen_stats[i_mdt][1] = (itier+1) + ' (with ' + most_dropped_tier[itier] + ' drops)'

	var most_ran = [];
	var most_ran_tier = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
	while (maps_ran.step()) {
		var name = maps_ran.getAsObject()['Name'];
		var tier = maps_ran.getAsObject()['Tier'];
		var iq = maps_ran.getAsObject()['IQ'] + maps_ran.getAsObject()['Bonus_IQ'];
		var ir = maps_ran.getAsObject()['IR'];
		var ps = maps_ran.getAsObject()['Pack_Size'];
		for (var i in base_map_names) {
			if (name.indexOf(base_map_names[i]) > -1) {
				base_map_name = base_map_names[i];
				break;
			}
		}
		var name_i = most_ran.map(function (element) { return element[0]; }).indexOf(base_map_name);
		if (name_i > -1) {
			most_ran[name_i][1] += 1;
		}
		else {
			most_ran.push([base_map_name, 1]);
		}
		most_ran_tier[tier-1] += 1;
		all_gen_stats[i_hmtier][1] = (tier > all_gen_stats[i_hmtier][1]) ? tier : all_gen_stats[i_hmtier][1];
		all_gen_stats[i_hmiq][1] = (iq > all_gen_stats[i_hmiq][1]) ? iq : all_gen_stats[i_hmiq][1];
		all_gen_stats[i_hmir][1] = (ir > all_gen_stats[i_hmir][1]) ? ir : all_gen_stats[i_hmir][1];
		all_gen_stats[i_hmps][1] = (ps > all_gen_stats[i_hmps][1]) ? ps : all_gen_stats[i_hmps][1];
	}
	var most_ran = most_ran.reduce(function(max, arr) { return max[1] >= arr[1] ? max : arr; });
	all_gen_stats[i_fmr][1] = most_ran[0] + ' (with ' + most_ran[1] + ' ran)';
	var itier = most_ran_tier.indexOf(Math.max.apply(Math, most_ran_tier));
	all_gen_stats[i_mrt][1] = (itier+1) + ' (with ' + most_ran_tier[itier] + ' ran)'
	all_gen_stats[i_amotm][1] = formatTime(all_gen_stats[i_amotm][1]);
    
    gerealStatTable(all_gen_stats);

	$("#tab1").addClass("tabs");
	$("#tab2").addClass("tabs");
	$("#tab3").addClass("tabs");
    $("#tab4").addClass("tabs");
    $("#tab5").addClass("tabs");
	$("#tab6").addClass("tabs");
}

// https://google-developers.appspot.com/chart/
function avgMapReturns(data) {
	var tab2 = document.getElementById("tab2");
	while (tab2.firstChild) {
		tab2.removeChild(tab2.firstChild);
	}
	var hr = document.createElement("hr");
	document.getElementById("tab2").appendChild(hr);
	var chart_div = document.createElement("div");
	chart_div.setAttribute("id", "map_returns_chart");
	chart_div.setAttribute("class", "map-charts");
	tab2.appendChild(chart_div);
	hr = document.createElement("hr");
	tab2.appendChild(hr);

	var data = google.visualization.arrayToDataTable(data);
	var title = 'All Maps Dropped within an IQ Range';
	var options = {
		chartArea: { width: '90%' },
		title : 'Averaged Map Returns Per Map Tier',
		//vAxis: {title: '# of Maps Dropped (Avg)'},
		hAxis: {title: 'Map Tier (Amount Ran)'},
		seriesType: 'bars',
		series: {5: {type: 'line'}},
		//backgroundColor: '#EEE',
		areaOpacity: 0.1,
		bar: {groupWidth: '95%'},
		legend: { position: 'bottom' }
	};
	var chart = new google.visualization.ComboChart(document.getElementById('map_returns_chart'));
	chart.draw(data, options);
}

function allMapDrops(rows) {
	var tab1 = document.getElementById("tab1");
	while (tab1.firstChild) {
		tab1.removeChild(tab1.firstChild);
	}
	var hr = document.createElement("hr");
	document.getElementById("tab1").appendChild(hr);
	var chart_div = document.createElement("div");
	chart_div.setAttribute("id", "map_drops_chart");
	chart_div.setAttribute("class", "map-charts");
	tab1.appendChild(chart_div);
	hr = document.createElement("hr");
	tab1.appendChild(hr);

	var data = new google.visualization.DataTable();
	data.addColumn('string', 'Map Tiers');
	data.addColumn('number', 'Maps Dropped');
	//data.addColumn({type: 'string', role: 'tooltip', 'p': {'html': true}});
	data.addRows(rows);
	var options = {
		chartArea: { width: '85%' },
		hAxis: { title: 'Map Tiers' },
		title: 'All Recorded Map Drops',
		subtitle: 'Includes those unlinked to a map ran.',
		//colors: ['#FFD700', '#C0C0C0', '#8C7853'],
		//tooltip: {isHtml: true, showColorCode: true, ignoreBounds: true}, // fuck its bugged in this and some other charts
		//focusTarget: 'category',
		legend: {position: 'none'}
		//backgroundColor: '#DFD'
	};
	var chart = new google.visualization.LineChart(document.getElementById('map_drops_chart'));
	chart.draw(data, options);
}

function mapDropsByIQ(data, num) {
	var tab3 = document.getElementById("tab3");
	if (num == 1) {
		while (tab3.firstChild) {
			tab3.removeChild(tab3.firstChild);
		}
		var hr = document.createElement("hr");
		tab3.appendChild(hr);
	}
	var chart_div = document.createElement("div");
	chart_div.setAttribute("id", "map_iq_piechart"+num);
	chart_div.setAttribute("class", "pie-charts");
	tab3.appendChild(chart_div);
	var title = 'All Maps Dropped within an IQ Range';
	if (num == 2) {
		title = 'Average Map Drops within an IQ Range';
		hr = document.createElement("hr");
		tab3.appendChild(hr);
	}

	var data = google.visualization.arrayToDataTable(data);
	var options = {
		chartArea: {
			width: '95%'
		},
		'title': title,
		is3D: true,
		pieSliceText : 'value'
	};
	var chart = new google.visualization.PieChart(document.getElementById('map_iq_piechart'+num));
	chart.draw(data, options);
}

function avgClearTimes(data) {
    var tab4 = document.getElementById("tab4");
    while (tab4.firstChild) {
        tab4.removeChild(tab4.firstChild);
    }
    var hr = document.createElement("hr");
    document.getElementById("tab4").appendChild(hr);
    var chart_div = document.createElement("div");
    chart_div.setAttribute("id", "clear_times_chart");
    chart_div.setAttribute("class", "bar-charts");
    tab4.appendChild(chart_div);
    hr = document.createElement("hr");
    tab4.appendChild(hr);

    var data = google.visualization.arrayToDataTable(data);
    var options = {
        title: 'Average Clear Times per Map Tier',
        legend: { position: 'none' },
        vAxis: { title: 'Map Tiers (Amount Ran)' },
        chartArea: { width: '80%', height: '90%' },
        bar: { groupWidth: "90%" }
    };
    var chart = new google.visualization.BarChart(document.getElementById('clear_times_chart'));
    chart.draw(data, options);
}

function gerealStatTable(all_gen_stats) {
    var tab5 = document.getElementById("tab5");
	while (tab5.firstChild) {
		tab5.removeChild(tab5.firstChild);
	}
	var table = document.createElement("table");
	table.setAttribute("id", "gen_stats");
	table.setAttribute("class", "table table-striped table-bordered");
	tab5.appendChild(table);

    if ( ! $.fn.DataTable.isDataTable('#gen_stats') ) {
	    var dt = $('#gen_stats').DataTable( {
			data: all_gen_stats,
			retrieve: true,
	        columns: [
	            { title: "Statistic (some have yet to be calculated)" },
	            { title: "Data" }
	        ],
	        language:
	        {
	            "info": 			"Showing _START_ to _END_ of _TOTAL_ Stats",
	            "infoEmpty": 		"Showing 0 to 0 of 0 Stats",
			    "infoFiltered": 	"(filtered from _MAX_ total Stats)",
			    "lengthMenu": 		"Show _MENU_ Stats",
	        },
	        order: []
	    } );
	    $('#gen_stats tbody').on('click', 'tr', function () {
	        $('#gen_stats tbody>tr.selected').removeClass('selected');
	        $(this).toggleClass('selected');
	    });
	}
	else {
		var dt = $('#gen_stats').DataTable();
		dt.destroy();
		gerealStatTable(all_gen_stats);
	}
}

function getMapDropTable (map_num) {
    return 	'<h4>Maps Dropped:</h4>'+
    	'<table id="map_drops'+map_num+'" class="map_drops table table-striped table-bordered" '+
    	'cellspacing="0" width="100%"></table>';
}

function addMapDropTableData(all_maps_dropped, map_num) {
	if ( ! $.fn.DataTable.isDataTable('#map_table'+map_num) ) {
		var dt = $('#map_drops'+map_num).DataTable( {
			data: all_maps_dropped[+map_num],
			retrieve: true,
	        columns: [
	            { title: "Date and Time Found" },
	            { title: "Name" },
	            { title: "Tier" },
	            { title: "IQ" },
	            { title: "IR" },
	            { title: "Pack Size" },
	            { title: "Rarity" },
	            { title: "Mods" },
	            { title: "More Mods" }
	        ],
	        columnDefs: [
	            {
	                render: function (data, type, row) {
	                	if (isNaN(data)) {
	                		return data;
	                	}
	                	return formatDateTime(+data)
	                },
	                targets: 0
	            },
	            {
	                render: function (data, type, row) {
	                	if (isNaN(data)) {
	                		return data;
	                	}
	                	return +data + '%'
	                },
	                targets: [3, 4, 5]
	            }
	        ],
	        language:
	        {
	            "info": 			"Showing _START_ to _END_ of _TOTAL_ Maps Dropped",
	            "infoEmpty": 		"Showing 0 to 0 of 0 Maps",
			    "infoFiltered": 	"(filtered from _MAX_ total Maps)",
			    "lengthMenu": 		"Show _MENU_ Maps Dropped",
	        },
	        order: [[0, 'asc']],
	        paging: false,
	        searching: false
	    } );
	}
	else {
		var dt = $('#map_table'+map_num).DataTable();
		dt.destroy();
		//addMapDropTableData(all_maps_dropped, map_num);
	}
}

function allMapDataTable(all_maps_ran, all_maps_dropped) {
    if ( ! $.fn.DataTable.isDataTable('#map_table' )) {
	    var dt = $('#map_table').DataTable( {
			data: all_maps_ran,
			retrieve: true,
	        columns: [
	            {
	                class:          "details-control",
	                orderable:      true,
	                //data:           null,
	                defaultContent: "",
	                searchable: 	false
	            },
	            { title: "Start / End / Clear Time" },
	            { title: "Name" },
	            { title: "Tier" },
	            { title: "IQ" },
	            { title: "Bonus IQ" },
	            { title: "IR" },
	            { title: "Pack Size" },
	            { title: "Rarity" },
	            { title: "Mods" },
	            { title: "More Mods" },
	            { title: "Time Cleared" }
	        ],
	        columnDefs: [
	            {
	                render: function (data, type, row) {
	                	if (isNaN(data)) {
	                		return data;
	                	}
	                	start = formatDateTime(+data);
	                	if (isNaN(+row[11])) {
	                		return start;
	                	}
	                	end = formatDateTime(+row[11]);
	                	clear_time = formatTime(row[11] - data, true);
	                	return '<span class="map_ID">'+data+'</span>'+start+'<br>'+end+'<br>'+clear_time;
	                },
	                targets: 1
	            },
	            {
	                render: function (data, type, row) {
	                	if (isNaN(data)) {
	                		return data;
	                	}
	                	return (+data + row[5]) + '%'; // problem here with index
	                },
	                targets: 4
	            },
	            {
	                render: function (data, type, row) {
	                	if (isNaN(data)) {
	                		return data;
	                	}
	                	return +data + '%'
	                },
	                targets: [6, 7]
	            },
	            {
	                targets: [5, 11], // Don't show Bonus_IQ or Time_Cleared columns
	                visible: false
	            }
	        ],
	        language:
	        {
	            "info": 			"Showing _START_ to _END_ of _TOTAL_ Maps Ran",
	            "infoEmpty": 		"Showing 0 to 0 of 0 Maps",
			    "infoFiltered": 	"(filtered from _MAX_ total Maps)",
			    "lengthMenu": 		"Show _MENU_ Maps Ran",
	        },
	        order: [[1, 'asc']]
	    } );
	    // Array to track the ids of the details displayed rows
	    var detailRows = [];
	    $('#map_table tbody').on('click', 'tr td.details-control', function () {
	        var tr = $(this).closest('tr');
	        var row = dt.row(tr);
	        var idx = $.inArray( tr.attr('id'), detailRows );
	        var map_num = $(this).text();
	        tr.toggleClass('selected');
	        if ( row.child.isShown() ) {
	            tr.removeClass('details');
	            row.child.hide();
	            // Remove from the 'open' array
	            detailRows.splice(idx, 1);
	        }
	        else {
	            tr.addClass('details');
	            row.child( getMapDropTable(map_num) ).show();
	            addMapDropTableData(all_maps_dropped, map_num);
	            // Add to the 'open' array
	            if (idx === -1) 
	                detailRows.push( tr.attr('id') );
	        }
	    });
	    // On each draw, loop over the `detailRows` array and show any child rows
	    dt.on('draw', function () {
	        $.each( detailRows, function (i, id) {
	            $('#'+id+' td.details-control').trigger('click');
	        });
	    });
	}
	else {
		var dt = $('#map_table').DataTable();
		dt.destroy();
		allMapDataTable(all_maps_ran, all_maps_dropped);
	}
}

function formatDateTime(unixTimestamp) {
	var dt = new Date(unixTimestamp * 1000);
	var year = dt.getFullYear();
	var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
	var month = months[dt.getMonth()];
	var day = dt.getDay();
	var hours = dt.getHours();
	var minutes = dt.getMinutes();
	var seconds = dt.getSeconds();
	var milliseconds = dt.getMilliseconds();
	var ms_str = '';
	var ampm = '';
	if (settings['hour12']) {
		if (hours > 12) {
			hours -= 12;
			ampm = 'pm';
		}
		else {
			ampm = 'am';
		}
	}
	if (hours < 10) 
		hours = '0' + hours;
	if (minutes < 10) 
		minutes = '0' + minutes;
	if (seconds < 10) 
		seconds = '0' + seconds;
	if (settings['milliseconds']) {
		ms_str = '.' + milliseconds;
	}
	return month + ' ' + day + ' ' + year + ' - ' + hours + ":" + minutes + ":" + seconds + ms_str + ' ' + ampm;
}
function formatChartTime(unixTimestamp) {
    var dt = new Date(unixTimestamp * 1000);
    var hours = dt.getUTCHours();
    var minutes = dt.getMinutes();
    var seconds = dt.getSeconds();
    var milliseconds = dt.getMilliseconds();
    if (!settings['milliseconds']) {
		milliseconds = 0;
	}
    return [hours, minutes, seconds, milliseconds];
}
function formatTime(unixTimestamp, short) {
    var dt = new Date(unixTimestamp * 1000);
	var days = Math.floor((unixTimestamp) / (1000*60*60*24));
    var hours = dt.getUTCHours();
    var minutes = dt.getMinutes();
    var seconds = dt.getSeconds();
    var milliseconds = dt.getMilliseconds();
    var day_str = 'Days';
    var hour_str = 'Hours';
    var min_str = 'Minutes';
    var sec_str = 'Seconds';
    var ms_str = '';
    if (days == 1)
    	day_str = 'Day';
    if (hours == 1)
    	hour_str = 'Hour';
    if (minutes == 1)
    	min_str = 'Minute';
    if (seconds == 1)
    	sec_str = 'Second';
    if (settings['milliseconds']) {
		ms_str = '.' + milliseconds;
	}
	if (short) {
		return minutes+' '+min_str+', '+seconds+ms_str+' '+sec_str;;
	}
    else {
    	return days+' '+day_str+', '+hours+' '+hour_str+', '+minutes+' '+min_str+', '+seconds+ms_str+' '+sec_str;
    }
}
function timeToHoursDecimal(unixTimestamp) {
	var hours = unixTimestamp / (60*60);
    return hours;
}

function allMapDropsTooltip(tier, drops) { //bugged
  return '<div class="tooltip">' +
      '<span class="ttTier">Map Tier: '+tier+'</span><br>' +
      '<span class="ttDrops">Maps Dropped</span><br>' +
      '<span class="ttAmount">'+drops+'</span><br>' +
      '</div>';
}

</script>

<style type="text/css">
@import url(http://fonts.googleapis.com/css?family=Carrois+Gothic+SC);
@import url(http://fonts.googleapis.com/css?family=Pathway+Gothic+One);
body {
	background: url(../images/background-fm.jpg) black no-repeat;
	color: #EEE;
}
#container {
	width: 1010px;
	margin: auto;
}
.wide-container {
	margin: 0 10px;
}
.header {
	background: url(../images/header.png) no-repeat;
	height: 219px;
}
.header h1 {
	font-family: 'Carrois Gothic SC', sans-serif;
	position: relative;
	left: 47px;
	top: 56px;
	height: 0;
}
.header h2 {
	font-family: 'Carrois Gothic SC', sans-serif;
	font-size: 20px;
	position: relative;
	left: 66px;
	top: 70px;
	height: 0;
	width: 300px;
}
.header h6 {
	font-family: 'Carrois Gothic SC', sans-serif;
	font-size: 7px;
	position: relative;
	left: 250px;
	top: 84px;
	height: 0;
}
.body {
	margin: auto 27px;
	width: 957px;
}
.db-upload {
    position: relative;
    left: 707px;
    top: 57px;
    width: 260px;
}
/*.db-upload > input {*/
#db_load_btn {
    display: none;
}
.db-upload a {
	background: url(../images/button.png);
	color: #ddd;
	cursor: pointer;
    display: inline-block;
    text-align: center;
    line-height: 83px;
    font-family: 'Pathway Gothic One', sans-serif;
    font-size: 28px;
    /*pointer-events: none;*/
    position: relative;
    width: 260px;
    height: 73px;
}
.db-upload img {
	color: #ddd;
	cursor: pointer;
    display: inline-block;
    position: absolute;
    width: 260px;
    height: 73px;
}
.db-upload a:hover, .db-upload a:active, .db-upload a:focus {
	color: #FFF;
	text-decoration: none;
}
.tab-links {
	display: inline-block;
	position: relative;
    left: 92px;
    top: 82px;
	visibility: hidden;
}
.tab-links-show {
	visibility: visible;
}
.tab-link {
	color: #ddd;
	cursor: pointer;
	display: inline-block;
	font-family: 'Pathway Gothic One', sans-serif;
	font-size: 16px;
	text-align: center;
	width: 116px;
}
.tab-link:hover, .tab-link:active, .tab-link:focus {
	color: #fff;
}
.tab-link-active {
	color: #fff;
	text-decoration: underline;
}
.body .tabs {
	background-color: #fff;
	border-left: 2px #6f5c31 solid;
	border-right: 2px #6f5c31 solid;
	display: none;
}
.wide-container .tabs {
	display: none;
}
.body .table_tabs, .wide-container .table_tabs {
	background: none;
	border: none;
	margin-top: 5px;
}
.body .tab-active, .wide-container .tab-active {
	color: #000;
	display: block;
}
.spacer {
	display: inline-block;
	width: 108px;
}
hr {
	margin-top: 0px;
    margin-bottom: 0px;
    border: 0;
    border-top: 2px solid #6f5c31;
}
.map-charts {
	width: 953px;
	height: 500px;
}
#map_iq_piechart1 {
	margin-right: 1px;
}
.bar-charts {
    width: 953px;
    height: 700px;
}
.pie-charts {
	display: inline-block;
	width: 476px;
	height: 500px;
}
table {
	color: #000;
}
thead {
	background-color: #A09883;
}
td.details-control {
    background: url('../images/details_open.png') no-repeat center center;
    cursor: pointer;
    text-indent: -999px;
}
tr.details td.details-control {
    background: url('../images/details_close.png') no-repeat center center;
}
td span.map_ID {
	display: none;
}
.dataTables_wrapper .dataTables_length, 
.dataTables_wrapper .dataTables_filter, 
.dataTables_wrapper .dataTables_info, 
.dataTables_wrapper .dataTables_processing, 
.dataTables_wrapper .dataTables_paginate {
    color: #eee;
}
#map_table .dataTables_wrapper .dataTables_length, 
#map_table .dataTables_wrapper .dataTables_filter, 
#map_table .dataTables_wrapper .dataTables_info, 
#map_table .dataTables_wrapper .dataTables_processing, 
#map_table .dataTables_wrapper .dataTables_paginate {
    color: #000;
}
table.map_drops thead tr {
	background-color: #A09883;
}
/*.tooltip {
	cursor: default;
    -webkit-user-select: none;
    -webkit-font-smoothing: antialiased;
    font-family: Roboto2;
    font-size: 24px;
}
.ttTier {
	fill: rgb(66, 66, 66);
    font-size: 24px;
}
.ttDrops {
	fill: rgb(117, 117, 117);
    font-size: 14px;
}
.ttAmount {
	fill: rgb(56, 113, 207);
    font-size: 24px;
}*/
footer {
	margin-top: 10px;
}
footer p {
	text-align: center;
}
</style>
</head>
<body>
<section>
	<article>
		<div id='container'>
			<header>
				<div class='header'>
					<h1>Map Drop Statistics</h1>
					<h2>Select a database file of which map data are to be read:</h2>
					<!-- <button id='db_load_btn' class='btn' type='button'>&nbsp; Load Database</button> -->
					<!-- <input id="uploadFile" placeholder="Choose File" disabled="disabled" />
					<div class="fileUpload btn btn-primary">
						<span>Upload</span>
						<input  id="db_load_btn" type="file" accept=".sqlite" disabled="true" />
					</div> -->
					<div class="db-upload">
						<!-- <label for="db_load_btn"> -->
							<!-- <img src="../images/button.png" /> -->
							<a id="db_load_link">Load Map Database</a>
							<input id="db_load_btn" type="file" accept=".sqlite" disabled="true"/>
						<!-- </label> -->
					</div>
					<div id="tab_links" class='tab-links'>
						<a id="tab_link1" class="tab-link"># of Map Drops</a>
						<a id="tab_link2" class="tab-link">Avg Map Returns</a>
						<a id="tab_link3" class="tab-link">Map Drops by IQ</a>
						<div class="spacer"></div>
                        <a id="tab_link4" class="tab-link">Avg Clear Times</a>
                        <a id="tab_link5" class="tab-link">General Stats</a>
						<a id="tab_link6" class="tab-link">All Map Data</a>
					</div>
				</div>
			</header>
			<div class='body'>
				<div id="tab1" class="tabs"></div>
				<div id="tab2" class="tabs"></div>
				<div id="tab3" class="tabs"></div>
                <div id="tab4" class="tabs"></div>
                <div id="tab5" class="tabs table_tabs"></div>
			</div>
		</div>
		<div class="wide-container">
			<div id="tab6" class="tabs table_tabs">
				<table id="map_table" class="table table-striped table-bordered" cellspacing="0" width="100%"></table>
			</div>
		</div>
		<footer>
			<p>Map Watch app developer (IGN) Grahf_Azura.  This map drop statistics file was created by Grahf_Azura.</p>
			<p><a href='http://www.pathofexile.com/'>Path of Exile</a> is a PC game developed and owned by <a href='http://www.grindinggear.com/'>Grinding Gear Games</a></p>
		</footer>
	</article>
</section>
</body>
</html>
